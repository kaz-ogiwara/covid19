let gData,gRegions=[],gThresholds={carriers:0,discharged:0,deaths:0,pcrtested:0};const LANG=$("html").attr("lang"),COLORS={default:"#3DC",carriers:["#3DC","#FEA","#ABC"],cases:["#6DF"],deaths:["#EB8","#ABC"],discharged:["#9FC"],serious:["#FEA"],pcrtested:["#4CD"],dark:"#399",selected:"#EC2",checking:"#abc",gender:{f:"#FE9",m:"#2B9"}},LABELS={ja:{change:"前日比",total:"合計",transition:{carriers:["有症状","無症状","確認中"],cases:["患者数"],discharged:["退院者数"],deaths:["確認済み","都道府県発表との差"],pcrtested:["PCR検査人数"],serious:["重症者数"]},unit:{carriers:"名",cases:"名",discharged:"名",pcrtested:"名",serious:"名",deaths:"名"},demography:{deaths:"死亡",serious:"重症",misc:"軽症・無症状・確認中"},age:["80代以上","70代","60代","50代","40代","30代","20代","10代","10歳未満","不明"]},en:{change:"Daily: ",total:"Total",transition:{carriers:["With Symptoms","No Symptom","Checking"],cases:["Active Cases"],discharged:["Discharged"],deaths:["MHLW Confirmed","Difference from Preliminary by Prefectures"],pcrtested:["PCR Tested"],serious:["Serious"]},unit:{carriers:"",cases:"",discharged:"",pcrtested:"",serious:"",deaths:""},demography:{deaths:"Deaths",serious:"Serious",misc:"Mild, No symptom, Checking"},age:["80s+","70s","60s","50s","40s","30s","20s","10s","Under 10","Unknown"]}},init=()=>{const t=t=>String(t).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),e=(e,a,s)=>{"-"!==(s=t(s).toString()).charAt(0)&&(s="+"+s);let o=e.find(".latest");o.find(".value").text(t(a)),o.find(".unit").text(LABELS[LANG].unit[e.attr("code")]),o.find(".type").text((t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase())(e.find(".switch[value=total]").text())),o.find(".change").text(LABELS[LANG].change+" "+s)},a=(a,s)=>{let o=a.find(".chart").empty().html("<canvas></canvas>").find("canvas")[0],r=a.find(".switch.selected").attr("value"),n=gData.transition[s],i=0,l=0;for(let t=3;t<n[0].length;t++)i+=n[n.length-1][t],l+=n[n.length-2][t];e(a,i,i-l);let d={type:"bar",data:{labels:[],datasets:[]},options:{aspectRatio:1.6,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(t){let e=t[0].xLabel.trim()+" 12:00";"ja"===LANG&&(e+="時点"),"en"===LANG&&(e="As of "+e);return e+" "+a.find(".switch.selected").text()},label:function(e,a){let o=[],r=0;return a.datasets.forEach(function(a,n){o.push(a.label+": "+t(a.data[e.index])+" "+LABELS[LANG].unit[s]),r+=a.data[e.index]}),a.datasets.length>=2&&o.push(LABELS[LANG].total+": "+t(r)+" "+LABELS[LANG].unit[s]),o}}},scales:{xAxes:[{stacked:!0,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{location:"bottom",stacked:!0,gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.7)",color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){if(Math.floor(e)===e)return t(e.toString())}}}]}}};a.width()>=400&&(d.options.aspectRatio=2);for(let t=3;t<n[0].length;t++)d.data.datasets.push({label:LABELS[LANG].transition[s][t-3],backgroundColor:COLORS[s][t-3],data:[]});n.forEach(function(t,e){if("total"===r){d.data.labels.push(t[1]+"/"+t[2]);for(let e=3;e<n[0].length;e++)d.data.datasets[e-3].data.push(t[e])}else if(e>=1){d.data.labels.push(t[1]+"/"+t[2]);let a=n[e-1];for(let e=3;e<n[0].length;e++)""!==t[e]&&""!==a[e]?d.data.datasets[e-3].data.push(t[e]-a[e]):d.data.datasets[e-3].data.push(0)}});let c=o.getContext("2d");window.myChart=new Chart(c,d)},s=t=>{let e=$("#select-pref-type").val(),a="rgba(90, 90, 90, 0.6)",s=gData["prefectures-data"][e][gData["prefectures-data"][e].length-1][parseInt(t)+2];return s>=1&&(a=COLORS.dark,0===gThresholds[e]&&(a=COLORS.default)),s>=gThresholds[e]&&gThresholds[e]>=1&&(a=COLORS.default),a},o=()=>{$("#japan-map").empty();const t=$("#japan-map").width();let e=[];gData["prefectures-map"].forEach(function(t,a){e.push({code:t.code,jp:t.ja,en:t.en,color:s(t.code),hoverColor:COLORS.selected,prefectures:[t.code]})}),$("#japan-map").japanMap({areas:e,selection:"prefecture",width:t,borderLineColor:"#242a3c",borderLineWidth:.25,lineColor:"#ccc",lineWidth:1,drawsBoxLine:!1,showsPrefectureName:!1,movesIslands:!0,onHover:function(t){r(t.code),n(t.code)}})},r=e=>{let a=$("#region-chart").empty().html("<canvas></canvas>"),o=a.find("canvas")[0],r=$("#select-pref-type").val(),i={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.4,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){return gData["prefectures-map"].forEach(function(e,a){e.ja!==t[0].yLabel&&e.en!==t[0].yLabel||$("#select-prefecture").val()!==e.code&&n(e.code)}),t[0].yLabel},label:function(t,e){return t.xLabel+{ja:" 名",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){return t(e)}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};a.outerWidth()>=400&&(i.options.aspectRatio=.5),""!==e&&(i.options.animation.duration=0);let l=[];gData["prefectures-data"][r][gData["prefectures-data"][r].length-1].forEach(function(t,e){e>=3&&l.push({name:gData["prefectures-map"][e-3][LANG],value:t,code:(e-2).toString()})}),l.sort((t,e)=>t.value<e.value?1:t.value>e.value?-1:0),l.forEach(function(t,a){i.data.labels.push(t.name),i.data.datasets[0].data.push(t.value),e==t.code?i.data.datasets[0].backgroundColor.push(COLORS.selected):i.data.datasets[0].backgroundColor.push(s(t.code))});let d=o.getContext("2d");window.myChart=new Chart(d,i)},n=t=>{$("#select-prefecture").val(t),$(".prefecture-chart").each(function(){let e=$(this).attr("code");i(t,e)})},i=(a,s)=>{let o=$(".prefecture-chart[code="+s+"]");o.find("h3").find("span").text(gData["prefectures-map"][parseInt(a)-1][LANG]);let r=o.find(".chart").empty().html("<canvas></canvas>"),n=r.find("canvas")[0],i=o.find(".switch.selected").attr("value"),l=gData["prefectures-data"][s],d=l[l.length-1][parseInt(a)+2],c=d-l[l.length-2][parseInt(a)+2];e(o,d,c);let h={type:"line",data:{labels:[],datasets:[]},options:{aspectRatio:1.6,animation:{duration:0},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,mode:"x",displayColors:!1,callbacks:{title:function(t){if(0===t[0].datasetIndex)return o.find("h3").text()},label:function(t,e){if(0===t.datasetIndex){return t.xLabel.trim()+": "+t.yLabel+{ja:" 名",en:" cases"}[LANG]}}}},scales:{xAxes:[{position:"bottom",gridLines:{display:!1},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:t=>" "+t+" "}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){if(Math.floor(e)===e)return t(e.toString())}}}]}}};r.outerWidth()>=400&&(h.options.aspectRatio=2),h.data.datasets.push({fill:!1,lineTension:.1,borderColor:COLORS.selected,borderWidth:3,pointRadius:2,pointBorderWidth:1,pointBackgroundColor:"#242a3c",data:[]});for(let t=1;t<=46;t++)h.data.datasets.push({fill:!1,lineTension:.1,borderColor:"#267",borderWidth:1,pointRadius:0,data:[]});l.forEach(function(t,e){if("total"===i){h.data.labels.push(t[1]+"/"+t[2]),h.data.datasets[0].data.push(t[parseInt(a)+2]);for(let e=1;e<=46;e++){let s=e>=parseInt(a)?e+1:e;h.data.datasets[e].data.push(t[s+2])}}else if(e>=1){h.data.labels.push(t[1]+"/"+t[2]);let s=l[e-1][parseInt(a)+2];h.data.datasets[0].data.push(t[parseInt(a)+2]-s);for(let s=1;s<=46;s++){let o=s>=parseInt(a)?s+1:s,r=l[e-1][o+2];h.data.datasets[s].data.push(t[o+2]-r)}}});let p=n.getContext("2d");window.myChart=new Chart(p,h)};$.getJSON("data/data.json",function(e){gData=e;try{(()=>{const t=t=>{let e=t.sort((t,e)=>t-e),a=[Math.floor(t.length/2),Math.ceil(t.length/2)];return(e[a[0]]+e[a[1]])/2};for(thType in gThresholds){let e=[],a=gData["prefectures-data"][thType],s=a[a.length-1];for(let t=3;t<s.length;t++)e.push(s[t]);gThresholds[thType]=t(e)}})(),$(".transition").each(function(){let t=$(this).attr("code");a($(this),t)}),(()=>{$wrapper=$("#demography-chart").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let e={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths[0],borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious[0],borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.misc,backgroundColor:COLORS.default,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(t){let e=t[0].yLabel,a=0;return t.forEach(function(t,e){a+=t.xLabel}),e+": "+a+" "+{ja:"名",en:"cases"}[LANG]},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+t.value+{ja:"名",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(e,a,s){return t(e)}}}],yAxes:[{stacked:!0,barPercentage:.8,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(e.options.aspectRatio=1.1),$wrapper.outerWidth()>=600&&(e.options.aspectRatio=1.3),gData.demography.forEach(function(t,a){e.data.labels.push(LABELS[LANG].age[a]);for(let a=0;a<3;a++)e.data.datasets[a].data.push(t[a])});let a=$canvas.getContext("2d");window.myChart=new Chart(a,e)})(),o(),r(""),n("13"),["last","transition","demography","prefectures"].forEach(function(t){$(".updated-"+t).text(gData.updated[t][LANG])}),$("#cover-block").fadeOut()}catch(t){alert("error")}}),$(".transition").find(".switch").on("click",function(){let t=$(this).closest(".transition");$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),a(t,t.attr("code"))}),$(".prefecture-chart").find(".switch").on("click",function(){let t=$(this).closest(".prefecture-chart");$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),i($("#select-prefecture").val(),t.attr("code"))}),$("#select-prefecture").on("change",function(){let t=$(this).val();n(t)}),$("#select-pref-type").on("change",function(){o(),r("")}),$(".more").on("click",function(){$(this).closest("p.notes").addClass("show")}),$('a[href^="#"]').click(function(){let t=$(this).attr("href"),e=$(t).offset().top;return $("body,html").animate({scrollTop:e},400,"swing"),!1})};$(function(){init()});