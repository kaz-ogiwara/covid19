let gData,gRegions=[];const LANG=$("html").attr("lang"),REGION_THRESHOLD=10,COLORS={default:"#3DC",dark:"#399",patient:"#ED9",discharge:"#3CA",test:"#3DC",dead:"#E95",positive:"#E95",selected:"#EC2",gender:{f:"#FE9",m:"#2B9"}},LABELS={ja:{chart:{patients:{dead:"死亡数",discharge:"退院数",patient:"患者数"},surveys:{patient:"有症数",positive:"陽性者数",test:"検査数"},demography:{f:"女性",m:"男性"}},age:{"10代":"10代","20代":"20代","30代":"30代","40代":"40代","50代":"50代","60代":"60代","70代":"70代","80代":"80代","90代":"90代","10歳未満":"10歳未満"}},en:{chart:{patients:{dead:"Deaths",discharge:"Discharged",patient:"Cases"},surveys:{patient:"Cases",positive:"Positive",test:"PCR Tests"},demography:{f:"Female",m:"Male"}},age:{"10代":"10s","20代":"20s","30代":"30s","40代":"40s","50代":"50s","60代":"60s","70代":"70s","80代":"80s","90代":"90s","10歳未満":"Under 10"}}},init=()=>{const a=()=>{let a=$("#patients-chart");a.empty(),a.html("<canvas></canvas>");let t=a.find("canvas")[0],e=$("#patients-block").find(".switch.selected").attr("value"),s="total"===e,o={type:"bar",data:{labels:[],datasets:[{label:LABELS[LANG].chart.patients.dead,backgroundColor:COLORS.dead,borderColor:COLORS.dead,data:[]},{label:LABELS[LANG].chart.patients.discharge,backgroundColor:COLORS.discharge,borderColor:COLORS.discharge,data:[]},{label:LABELS[LANG].chart.patients.patient,backgroundColor:COLORS.patient,borderColor:COLORS.patient,data:[]}]},options:{aspectRatio:1.2,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(a){let t=a[0].xLabel+" "+gData.transition[a[0].index][2]+":00";return{ja:"",en:"As of "}[LANG]+t+{ja:{total:"時点 累計",new:"時点新規"},en:{total:" Total",new:" New cases"}}[LANG][e]},label:function(a,t){let s,o=gData.transition[a.index],n={ja:"名",en:""};if("new"===e&&a.index>=1){const t=gData.transition[a.index-1];s=[LABELS[LANG].chart.patients.patient+": "+(o[5]-t[5])+n[LANG],LABELS[LANG].chart.patients.discharge+": "+(o[6]-t[6])+n[LANG],LABELS[LANG].chart.patients.dead+": "+(o[7]-t[7])+n[LANG]]}else s=[LABELS[LANG].chart.patients.patient+": "+o[5]+n[LANG],LABELS[LANG].chart.patients.discharge+": "+o[6]+n[LANG],LABELS[LANG].chart.patients.dead+": "+o[7]+n[LANG]];return s}}},scales:{xAxes:[{stacked:s,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.7)"}}],yAxes:[{location:"bottom",stacked:!1,gridLines:{display:!0,color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,t,e){return a.toString()}}}]}}};a.width()>=400&&(o.options.aspectRatio=1.5),a.width()>=600&&(o.options.aspectRatio=1.8),gData.transition.forEach(function(a,t){if(o.data.labels.push(a[0]+"/"+a[1]),"new"===e&&t>=1){let e=gData.transition[t-1];o.data.datasets[2].data.push(a[5]-e[5]),o.data.datasets[1].data.push(a[6]-e[6]),o.data.datasets[0].data.push(a[7]-e[7])}else o.data.datasets[2].data.push(a[5]),o.data.datasets[1].data.push(a[6]),o.data.datasets[0].data.push(a[7])});let n=t.getContext("2d");window.myChart=new Chart(n,o)},t=()=>{let a=$("#surveys-chart");a.empty(),a.html("<canvas></canvas>");let t=a.find("canvas")[0],e=$("#surveys-block").find(".switch.selected").attr("value"),s="total"===e,o={type:"bar",data:{labels:[],datasets:[{label:LABELS[LANG].chart.surveys.patient,backgroundColor:[],borderColor:COLORS.patient,data:[]},{label:LABELS[LANG].chart.surveys.positive,backgroundColor:[],borderColor:COLORS.positive,data:[]},{label:LABELS[LANG].chart.surveys.test,backgroundColor:[],borderColor:COLORS.test,data:[]}]},options:{aspectRatio:1.2,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(a){let t=a[0].xLabel+" "+gData.transition[a[0].index][2]+":00";return{ja:"",en:"As of "}[LANG]+t+{ja:{total:"時点 累計",new:"時点新規"},en:{total:" Total",new:" New cases"}}[LANG][e]},label:function(a,t){let s,o=gData.transition[a.index],n={ja:"名",en:""};if("new"===e&&a.index>=1){const t=gData.transition[a.index-1];s=[LABELS[LANG].chart.surveys.test+": "+(o[3]-t[3])+n[LANG],LABELS[LANG].chart.surveys.positive+": "+(o[4]-t[4])+n[LANG],LABELS[LANG].chart.surveys.patient+": "+(o[5]-t[5])+n[LANG]]}else s=[LABELS[LANG].chart.surveys.test+": "+o[3]+n[LANG],LABELS[LANG].chart.surveys.positive+": "+o[4]+n[LANG],LABELS[LANG].chart.surveys.patient+": "+o[5]+n[LANG]];return s}}},scales:{xAxes:[{stacked:s,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.7)"}}],yAxes:[{location:"bottom",stacked:!1,gridLines:{display:!0,color:"rgba(255, 255, 255, 0.3)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,t,e){return a.toString()}}}]}}};a.width()>=400&&(o.options.aspectRatio=1.5),a.width()>=600&&(o.options.aspectRatio=1.8),gData.transition.forEach(function(a,t){if(o.data.labels.push(a[0]+"/"+a[1]),"new"===e&&t>=1){let e=gData.transition[t-1];o.data.datasets[2].data.push(a[3]-e[3]),o.data.datasets[1].data.push(a[4]-e[4]),o.data.datasets[0].data.push(a[5]-e[5])}else o.data.datasets[2].data.push(a[3]),o.data.datasets[1].data.push(a[4]),o.data.datasets[0].data.push(a[5]);let s=a[0]>=3&&a[1]>=4?COLORS.dark:COLORS.test;o.data.datasets[2].backgroundColor.push(s),o.data.datasets[1].backgroundColor.push(COLORS.positive),o.data.datasets[0].backgroundColor.push(COLORS.patient)});let n=t.getContext("2d");window.myChart=new Chart(n,o)},e=a=>{let t="rgba(90, 90, 90, 0.3)";return a>=1&&(t=COLORS.dark),a>=10&&(t=COLORS.default),t},s=a=>{let t=$("#region-chart");t.empty(),t.html("<canvas></canvas>");let s=t.find("canvas")[0],o={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.6,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(a){return a[0].yLabel},label:function(a,t){return a.xLabel+{ja:" 名",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,t,e){return a.toString()}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};t.outerWidth()>=400&&(o.options.aspectRatio=.8),t.outerWidth()>=600&&(o.options.aspectRatio=1),""!==a&&(o.options.animation.duration=0),gData.prefectures.forEach(function(t,s){t.value>=1&&(o.data.labels.push(t[LANG]),o.data.datasets[0].data.push(t.value),a===t.code?o.data.datasets[0].backgroundColor.push(COLORS.selected):o.data.datasets[0].backgroundColor.push(e(t.value)))});let n=s.getContext("2d");window.myChart=new Chart(n,o)};$.getJSON("data/data.json",function(o){gData=o,t(),a(),(()=>{$wrapper=$("#demography-chart"),$wrapper.empty(),$wrapper.html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let a={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].chart.demography.f,backgroundColor:COLORS.gender.f,data:[]},{label:LABELS[LANG].chart.demography.m,backgroundColor:COLORS.gender.m,data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(a){return a[0].yLabel},label:function(a,t){return t.datasets[a.datasetIndex].label+": "+a.value+{ja:"名",en:""}[LANG]}}},scales:{xAxes:[{position:"top",color:"yellow",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,t,e){return a.toString()}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)",callback:function(a){return LABELS[LANG].age[a]}}}]}}};$wrapper.outerWidth()>=400&&(a.options.aspectRatio=1.1),$wrapper.outerWidth()>=600&&(a.options.aspectRatio=1.3);let t=0;for(let e in gData.demography){for(let s in gData.demography[e]){let o=gData.demography[e][s];0===t&&a.data.labels.push(s),a.data.datasets[t].data.push(o)}t++}let e=$canvas.getContext("2d");window.myChart=new Chart(e,a)})(),(()=>{const a=$("#japan-map").width();let t=[];gData.prefectures.forEach(function(a,s){t.push({code:a.code,jp:a.jp,en:a.en,color:e(a.value),hoverColor:COLORS.selected,prefectures:[a.code]})}),$("#japan-map").japanMap({areas:t,width:a,borderLineColor:"#fcfcfc",borderLineWidth:.25,lineColor:"#ccc",lineWidth:1,drawsBoxLine:!1,showsPrefectureName:!1,movesIslands:!0,fontSize:11,onHover:function(a){s(a.code,0)}})})(),s(""),["last","transition","demography","prefectures"].forEach(function(a){$(".updated-"+a).text(gData.updated[a][LANG])}),$("#container").addClass("show")}),$(".switch").on("click",function(){$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),$(this).closest("#patients-block")[0]&&a(),$(this).closest("#surveys-block")[0]&&t()})};$(function(){init()});