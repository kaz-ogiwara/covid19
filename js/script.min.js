let gData,gRegions=[];const LANG=$("html").attr("lang"),REGION_THRESHOLD=10,COLORS={default:"#3DC",carriers:"#3DC",cases:"#6DF",deaths:"#EB8",discharged:"#9FC",serious:"#FEA",pcrtested:"#4CD",dark:"#399",selected:"#EC2",gender:{f:"#FE9",m:"#2B9"}},LABELS={ja:{change:"前日比",unit:{carriers:"名",cases:"名",discharged:"名",pcrtested:"名",serious:"名",deaths:"名"},demography:{deaths:"死亡",serious:"重症",discharged:"退院",misc:"その他",nosym:"無症状"},age:["10歳未満","10代","20代","30代","40代","50代","60代","70代","80代","90代","非公表"]},en:{change:"DoD: ",unit:{carriers:"",cases:"",discharged:"",pcrtested:"",serious:"",deaths:""},demography:{deaths:"Deaths",serious:"Serious",discharged:"Discharged",misc:"Misc",nosym:"No Symptom"},age:["Under 10","10s","20s","30s","40s","50s","60s","70s","80s","90s","Unknown"]}},init=()=>{const a=a=>String(a).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),t=(t,e)=>{let s=t.find(".chart").empty().html("<canvas></canvas>").find("canvas")[0],o=t.find(".switch.selected").attr("value"),r=gData.transition[e],n=r[r.length-1][3],i=n-r[r.length-2][3];"-"!==(i=a(i).toString()).charAt(0)&&(i="+"+i);let d=t.find(".latest");d.find(".value").text(a(n)),d.find(".unit").text(LABELS[LANG].unit[e]),d.find(".type").text(t.find(".switch[value=total]").text()),d.find(".change").text(LABELS[LANG].change+" "+i);let l={type:"bar",data:{labels:[],datasets:[{label:t.find("h3:first").text(),backgroundColor:COLORS[e],data:[]}]},options:{aspectRatio:1.8,responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!1,callbacks:{title:function(a){let e=a[0].xLabel+" 12:00";"ja"===LANG&&(e+="時点"),"en"===LANG&&(e="As of "+e);return e+" "+t.find(".switch.selected").text()},label:function(t,s){return s.datasets[0].label+": "+a(s.datasets[0].data[t.index])+" "+LABELS[LANG].unit[e]}}},scales:{xAxes:[{stacked:!1,gridLines:{display:!1},ticks:{fontColor:"rgba(255,255,255,0.7)",maxRotation:0,minRotation:0,callback:a=>" "+a+" "}}],yAxes:[{location:"bottom",stacked:!1,gridLines:{display:!0,zeroLineColor:"rgba(255,255,255,0.7)",color:"rgba(255, 255, 255, 0.3)"},ticks:{beginAtZero:!0,fontColor:"rgba(255,255,255,0.7)",callback:function(t,e,s){if(Math.floor(t)===t)return a(t.toString())}}}]}}};t.width()>=400&&(l.options.aspectRatio=2.4),r.forEach(function(a,t){if("total"===o)l.data.labels.push(a[1]+"/"+a[2]),l.data.datasets[0].data.push(a[3]);else if(t>=1){l.data.labels.push(a[1]+"/"+a[2]);let e=r[t-1];l.data.datasets[0].data.push(a[3]-e[3])}});let c=s.getContext("2d");window.myChart=new Chart(c,l)},e=a=>{let t="rgba(90, 90, 90, 0.3)";return a>=1&&(t=COLORS.dark),a>=10&&(t=COLORS.default),t},s=a=>{let t=$("#region-chart");t.empty(),t.html("<canvas></canvas>");let s=t.find("canvas")[0],o={type:"horizontalBar",data:{labels:[],datasets:[{label:"",backgroundColor:[],data:[]}]},options:{aspectRatio:.4,animation:{duration:1e3},responsive:!0,legend:{display:!1},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(a){return a[0].yLabel},label:function(a,t){return a.xLabel+{ja:" 名",en:" cases"}[LANG]}}},scales:{xAxes:[{position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,t,e){return a.toString()}}}],yAxes:[{gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};t.outerWidth()>=400&&(o.options.aspectRatio=.4),""!==a&&(o.options.animation.duration=0),gData.prefectures.forEach(function(t,s){t.value>=1&&(o.data.labels.push(t[LANG]),o.data.datasets[0].data.push(t.value),a===t.code?o.data.datasets[0].backgroundColor.push(COLORS.selected):o.data.datasets[0].backgroundColor.push(e(t.value)))});let r=s.getContext("2d");window.myChart=new Chart(r,o)};$.getJSON("data/data.json",function(a){gData=a,$(".transition-block").each(function(){let a=$(this).attr("code");t($(this),a)}),(()=>{$wrapper=$("#demography-chart").empty().html("<canvas></canvas>"),$canvas=$wrapper.find("canvas")[0];let a={type:"horizontalBar",data:{labels:[],datasets:[{label:LABELS[LANG].demography.deaths,backgroundColor:COLORS.deaths,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.serious,backgroundColor:COLORS.serious,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.misc,backgroundColor:COLORS.dark,borderWidth:.5,borderColor:"#242a3c",data:[]},{label:LABELS[LANG].demography.nosym,backgroundColor:COLORS.cases,borderWidth:.5,borderColor:"#242a3c",data:[]}]},options:{aspectRatio:.9,responsive:!0,legend:{display:!0,labels:{fontColor:"rgba(255, 255, 255, 0.7)"}},title:{display:!1},tooltips:{xPadding:24,yPadding:12,displayColors:!0,callbacks:{title:function(a){let t=a[0].yLabel,e=0;return a.forEach(function(a,t){e+=a.xLabel}),t+": "+e+" "+{ja:"名",en:"cases"}[LANG]},label:function(a,t){return t.datasets[a.datasetIndex].label+": "+a.value+{ja:"名",en:" cases"}[LANG]}}},scales:{xAxes:[{stacked:!0,position:"top",gridLines:{color:"rgba(255,255,255,0.2)"},ticks:{suggestedMin:0,fontColor:"rgba(255,255,255,0.7)",callback:function(a,t,e){return a.toString()}}}],yAxes:[{stacked:!0,barPercentage:.8,gridLines:{color:"rgba(255,255,255,0.1)"},ticks:{fontColor:"rgba(255,255,255,0.7)"}}]}}};$wrapper.outerWidth()>=400&&(a.options.aspectRatio=1.1),$wrapper.outerWidth()>=600&&(a.options.aspectRatio=1.3),gData.demography.forEach(function(t,e){a.data.labels.push(LABELS[LANG].age[e]);for(let e=0;e<4;e++)a.data.datasets[e].data.push(t[e])});let t=$canvas.getContext("2d");window.myChart=new Chart(t,a)})(),(()=>{const a=$("#japan-map").width();let t=[];gData.prefectures.forEach(function(a,s){t.push({code:a.code,jp:a.jp,en:a.en,color:e(a.value),hoverColor:COLORS.selected,prefectures:[a.code]})}),$("#japan-map").japanMap({areas:t,width:a,borderLineColor:"#fcfcfc",borderLineWidth:.25,lineColor:"#ccc",lineWidth:1,drawsBoxLine:!1,showsPrefectureName:!1,movesIslands:!0,fontSize:11,onHover:function(a){console.log("a"),s(a.code,0)}})})(),s(""),["last","transition","demography","prefectures"].forEach(function(a){$(".updated-"+a).text(gData.updated[a][LANG])}),$("#container").addClass("show")}),$(".switch").on("click",function(){$(this).siblings(".switch").removeClass("selected"),$(this).addClass("selected"),t($(this).closest(".transition-block"),$(this).closest(".transition-block").attr("code"))}),$(".more").on("click",function(){$(this).closest("p.notes").addClass("show")})};$(function(){init()});